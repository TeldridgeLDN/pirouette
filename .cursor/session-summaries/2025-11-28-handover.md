# Agent Handover Document
**Date:** 2025-11-28
**Project:** Pirouette (Design Confidence for Non-Designers)
**Directory:** `/Users/tomeldridge/pirouette`

---

## Project Overview

Pirouette is a SaaS tool that analyses landing page designs and provides data-driven recommendations based on patterns from 50+ award-winning sites.

- **Tech Stack:** Next.js 15, TypeScript, Tailwind CSS, Clerk (auth), Supabase (DB), Stripe (payments)
- **Target:** Bootstrapped founders, agencies, e-commerce owners
- **Pricing:** Free (1/week) → Pro £29/mo (unlimited) → Agency £99/mo

---

## What Was Accomplished This Session

### 1. Anonymous User Flow (Phase 1)
- ✅ `HeroAnalyzeForm` - URL input on landing page for anonymous users
- ✅ IP-based rate limiting (1/day for anonymous, 1/week for free accounts)
- ✅ Database migration for nullable `user_id` on jobs/reports tables
- ✅ `anonymous_analyses` table for rate limit tracking
- ✅ Analysis progress page (`/analyze/[jobId]`)
- ✅ Report page (`/report/[id]`) with expandable recommendations
- ✅ Email capture modal for converting anonymous → registered

### 2. Payment System (Phase 1)
- ✅ Stripe library installed and configured (`src/lib/stripe/index.ts`)
- ✅ Checkout session endpoint (`/api/create-checkout-session`)
- ✅ Billing portal endpoint (`/api/billing-portal`)
- ✅ Stripe webhook handler (`/api/webhooks/stripe`)
- ✅ Upgrade modal component (`src/components/UpgradeModal.tsx`)

### 3. Feature Gating
- ✅ Feature flags utility (`src/lib/features.ts`)
- ✅ `useFeatureAccess` hook for client-side checks
- ✅ `FeatureGate` component for conditional rendering
- ✅ User plan API (`/api/user/plan`)

### 4. Bug Fixes
- ✅ Navigation now shows auth state (Dashboard + UserButton when logged in)
- ✅ Database migration applied for anonymous analyses

---

## Current State

### What's Working
| Component | Status | Notes |
|-----------|--------|-------|
| Landing page | ✅ | URL input form, pricing, testimonials |
| Authentication | ✅ | Clerk with Google OAuth |
| Dashboard | ✅ | Basic layout, shows user info |
| Job creation | ✅ | Creates job in Supabase |
| Rate limiting | ✅ | IP-based (anonymous) and user-based (authenticated) |
| Progress page | ✅ | Shows job status, polls for updates |
| Navigation | ✅ | Dynamic auth state |

### What's NOT Working / Incomplete
| Component | Status | Notes |
|-----------|--------|-------|
| Railway analysis service | ⏳ | Not deployed - this does the actual analysis |
| Report generation | ⏳ | Needs Railway service to create reports |
| Stripe checkout | ⏳ | Endpoints created, needs testing with real Stripe keys |
| Email capture flow | ⏳ | Modal created, claim-report endpoint exists |

---

## Database State

**Supabase Tables:**
- `users` - Synced from Clerk
- `jobs` - Analysis job queue (user_id now nullable)
- `reports` - Completed analyses (user_id now nullable)
- `patterns` - Design pattern cache
- `anonymous_analyses` - IP rate limit tracking

**Applied Migrations:**
1. `001_initial_schema.sql` ✅
2. `002_rls_policies.sql` ✅
3. `003_anonymous_analyses.sql` ✅ (applied this session)

---

## Key Files Created/Modified This Session

### New Components
- `src/components/Navigation.tsx` - Dynamic auth-aware nav
- `src/components/HeroAnalyzeForm.tsx` - Landing page URL input
- `src/components/EmailCaptureModal.tsx` - Convert anonymous to registered
- `src/components/UpgradeModal.tsx` - Upgrade prompts
- `src/components/DashboardAnalyzeForm.tsx` - Dashboard analysis form
- `src/components/FeatureGate.tsx` - Pro feature gating

### New API Routes
- `src/app/api/analyze/route.ts` - Submit analysis (supports anonymous)
- `src/app/api/jobs/[jobId]/route.ts` - Job status
- `src/app/api/reports/[id]/route.ts` - Get report
- `src/app/api/claim-report/route.ts` - Claim anonymous report
- `src/app/api/create-checkout-session/route.ts` - Stripe checkout
- `src/app/api/billing-portal/route.ts` - Stripe billing portal
- `src/app/api/webhooks/stripe/route.ts` - Stripe webhooks
- `src/app/api/user/plan/route.ts` - User plan info

### New Pages
- `src/app/analyze/[jobId]/page.tsx` - Analysis progress
- `src/app/report/[id]/page.tsx` - Report display

### Utilities
- `src/lib/stripe/index.ts` - Stripe API helpers
- `src/lib/features.ts` - Feature flags per plan
- `src/hooks/useFeatureAccess.ts` - Client-side feature checks
- `src/lib/rate-limit.ts` - Rate limiting logic (extended for anonymous)

---

## Environment Variables Needed

```bash
# Clerk (already configured)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_...
CLERK_SECRET_KEY=sk_...

# Supabase (already configured)
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# Stripe (needs to be added for payment testing)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRO_29_PRICE_ID=price_...
STRIPE_PRO_49_PRICE_ID=price_...
STRIPE_AGENCY_PRICE_ID=price_...

# Railway (when deployed)
ANALYSIS_SERVICE_URL=https://...
```

---

## Test User

- **Email:** tom.eldridge@googlemail.com
- **Name:** bobby test
- **Plan:** free (can be upgraded via SQL)
- **Clerk ID:** user_364UuQ6AZwmXFYuwl8N7bEovCeT

---

## Next Steps (Suggested)

### Priority 1: Railway Analysis Service
The core analysis functionality requires the Railway backend service. This includes:
- Playwright for browser automation
- Screenshot capture
- Design analysis algorithms
- Job status updates
- Report generation

### Priority 2: Stripe Testing
- Add Stripe test keys to `.env.local`
- Create products/prices in Stripe dashboard
- Test checkout flow end-to-end
- Test webhook handling

### Priority 3: Dashboard Enhancements
- Show analysis history
- Display usage quota
- Add billing management link

---

## Commands

```bash
# Start dev server
npm run dev

# Build
npm run build

# Check Taskmaster tasks
task-master list
task-master next
```

---

## Known Issues

1. **Clerk deprecation warning:** `afterSignInUrl` prop is deprecated, should use `fallbackRedirectUrl`
2. **Console 404:** Some favicon/image requests return 404 (non-critical)

---

## Files to Review

For the next agent, these files provide the best context:
1. `AGENTS.md` - Project overview and architecture
2. `.taskmaster/docs/prd.txt` - Product requirements
3. `CHANGELOG.md` - What was implemented
4. This handover document

---

*Handover prepared by Claude on 2025-11-28*

