# Pirouette Handover Document
## Session: 28 November 2025 (Afternoon)

---

## ğŸ¯ Project Overview

**Pirouette** - Design Confidence, Backed by Data

A SaaS tool that analyses landing page designs and provides data-driven recommendations based on patterns from award-winning sites.

- **Tech Stack**: Next.js 15, TypeScript, Tailwind CSS, Clerk Auth, Supabase, Stripe
- **Target Market**: Bootstrapped founders, agencies, e-commerce owners
- **Pricing**: Free tier (1/week) â†’ Pro Â£29/mo â†’ Agency Â£99/mo

---

## âœ… Tasks Completed This Session

| Task | Description | Files Created/Modified |
|------|-------------|----------------------|
| **Task 16** | BullMQ Worker for Analysis Jobs | `railway/src/queue/config.ts`, `railway/src/queue/worker.ts`, `railway/src/worker.ts`, `railway/src/server.ts`, `railway/Dockerfile` |
| **Task 11** | Job Status Polling (already done) | Verified existing implementation |
| **Task 20** | Legal Pages (UK GDPR compliant) | `src/app/terms/page.tsx`, `src/app/privacy/page.tsx`, `src/app/ethics/page.tsx` |
| **Task 17** | Screenshot Capture (already done) | Verified in `railway/src/utils/browser.ts`, `railway/src/utils/supabase.ts` |
| **Task 19** | Error Handling & Monitoring | `src/app/not-found.tsx`, `src/app/error.tsx`, `src/app/global-error.tsx`, `src/app/loading.tsx`, `src/lib/errors.ts` |
| **Task 29** | Report Quality Validation | `src/lib/analysis/utils/quality-validator.ts`, `src/components/QualityBanner.tsx` |
| **Task 51** | Created aggregate benchmarking task | New task added to Taskmaster |

---

## ğŸ“ Key Files Created/Modified

### Railway Service (Backend Worker)
```
railway/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”œâ”€â”€ config.ts      # Redis connection, queue settings, job options
â”‚   â”‚   â”œâ”€â”€ worker.ts      # BullMQ worker with retry logic
â”‚   â”‚   â””â”€â”€ index.ts       # Re-exports
â”‚   â”œâ”€â”€ worker.ts          # Standalone worker entry point
â”‚   â””â”€â”€ server.ts          # Updated with queue integration
â”œâ”€â”€ Dockerfile             # Multi-mode (server/worker/all)
â””â”€â”€ package.json           # Added worker scripts
```

### Legal Pages
```
src/app/
â”œâ”€â”€ terms/page.tsx         # Terms of Service (UK law)
â”œâ”€â”€ privacy/page.tsx       # Privacy Policy (UK GDPR)
â””â”€â”€ ethics/page.tsx        # Crawler Ethics Policy
```

### Error Handling
```
src/app/
â”œâ”€â”€ not-found.tsx          # 404 page
â”œâ”€â”€ error.tsx              # Runtime error boundary
â”œâ”€â”€ global-error.tsx       # Root error catch-all
â””â”€â”€ loading.tsx            # Global loading state

src/lib/
â””â”€â”€ errors.ts              # Error classes & utilities
```

### Quality Validation
```
src/lib/analysis/utils/
â””â”€â”€ quality-validator.ts   # 10 quality checks, scoring system

src/components/
â””â”€â”€ QualityBanner.tsx      # Quality display component
```

---

## ğŸ”§ Current State

### What's Working
- âœ… Landing page with hero section and pricing
- âœ… Clerk authentication (email + Google OAuth)
- âœ… Supabase database integration
- âœ… Anonymous analysis flow (IP rate limiting)
- âœ… Analysis job creation and status polling
- âœ… Report display with recommendations
- âœ… Revenue impact and ROI calculations
- âœ… Traffic-based conditional recommendations
- âœ… Stripe checkout and billing portal
- âœ… Legal pages (Terms, Privacy, Ethics)
- âœ… Error handling and custom error pages
- âœ… Report quality validation system

### What Needs Testing/Deployment
- âš ï¸ BullMQ worker (needs Redis in Railway)
- âš ï¸ Railway service deployment
- âš ï¸ Quality validation UI integration in report page

### Outstanding Issues
- Dashboard page exists but needs URL submission form (Task 35)
- Subscription management UI not complete (Task 41)

---

## ğŸ“Š Pending Tasks (Priority Order)

### High Priority
1. **Task 35** - Add URL Submission Form to Dashboard
2. **Task 41** - Subscription Management & Billing Portal
3. **Task 48** - Trial User Experience & Conversion Flow

### Medium Priority
4. **Task 14** - User Dashboard (partial)
5. **Task 42** - Pro Status Indicators
6. **Task 43** - Historical Tracking for Pro Users
7. **Task 44** - PDF Export for Pro Users
8. **Task 45** - Competitor Comparison
9. **Task 51** - Industry Benchmarking System

### Lower Priority
10. **Task 46** - Cancellation & Churn Handling
11. **Task 47** - Failed Payments & Dunning
12. **Task 49** - Account Deletion & GDPR Export
13. **Task 50** - Referral Program

---

## ğŸ—ƒï¸ Database State

### Tables
- `users` - Synced from Clerk
- `jobs` - Analysis job queue
- `reports` - Completed analysis reports
- `anonymous_analyses` - IP-based rate limiting

### Recent Migrations
- `004_weekly_traffic.sql` - Adds `weekly_traffic` column to jobs

### Storage
- `screenshots` bucket - Captured page screenshots

---

## ğŸ”‘ Environment Variables

```bash
# Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_...
CLERK_SECRET_KEY=sk_...
CLERK_WEBHOOK_SECRET=whsec_...

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_PRO_PRICE_ID=price_...

# Railway (for worker)
REDIS_URL=redis://...
ANALYSIS_SERVICE_URL=https://...
```

---

## ğŸ“ Key Architecture Decisions

### Analysis Flow
1. User submits URL â†’ `/api/analyze` creates job in Supabase
2. Job triggers Railway service â†’ adds to BullMQ queue
3. Worker processes: Playwright screenshot â†’ Analysis â†’ Save report
4. Frontend polls `/api/jobs/[id]` â†’ redirects to `/report/[id]` when done

### Quality Validation
- 10 quality checks with weighted scoring
- 80% threshold for production display
- Quality data returned with report API (`?includeQuality=true`)

### Legal Compliance (UK)
- UK GDPR and DPA 2018 compliant
- ICO listed as supervisory authority
- robots.txt compliance for crawler
- User agent: `PirouetteBot/1.0`

---

## ğŸš€ Next Steps for New Agent

1. **Start with Task 35** - Dashboard needs URL form to be useful
2. **Then Task 41** - Subscription management is critical for Pro users
3. **Consider Task 48** - Trial experience drives conversions

### Quick Commands
```bash
# Start dev server
npm run dev

# View tasks
task-master list --status pending

# Get next task
task-master next

# Railway worker (local)
cd railway && npm run dev:worker
```

---

## ğŸ“‚ Files to Review First

1. `AGENTS.md` - Project overview and commands
2. `CHANGELOG.md` - What's been built
3. `.taskmaster/tasks/tasks.json` - All task details
4. `src/app/dashboard/page.tsx` - Current dashboard state
5. `src/lib/features.ts` - Feature gating system

---

## ğŸ’¡ Tips for Continuing

- **UK English** - Use British spellings throughout
- **Taskmaster** - Always update task status when starting/completing
- **Quality** - Run `npm run lint` before committing
- **Testing** - Browser testing available via MCP tools
- **Legal** - All legal pages reference `@pirouette.design` email domain

---

## ğŸ”„ Uncommitted Changes

The following files have changes ready to commit:
- Legal pages (terms, privacy, ethics)
- Error handling pages
- Quality validation system
- BullMQ worker infrastructure
- Footer links update
- CHANGELOG.md

**Suggested commit message:**
```
feat: Add legal pages, error handling, quality validation, and BullMQ worker

- Legal: Terms, Privacy Policy, Crawler Ethics (UK GDPR compliant)
- Error handling: 404, error boundary, global-error, loading states
- Quality validation: 10 checks with 80% threshold
- BullMQ: Queue config, worker, multi-mode Dockerfile
- Updated footer links on landing and pricing pages
```

---

*Generated: 28 November 2025*
*Project: Pirouette (Design Confidence for Non-Designers)*
*Location: /Users/tomeldridge/pirouette*

